{% extends 'base.html' %}

{% block title %}Search Shipments - PICS{% endblock %}

{% block content %}
<div class="min-h-screen py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Search Shipments</h1>
            <p class="mt-2 text-gray-600">Find and manage your shipments</p>
        </div>

        <!-- Search Form -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fas fa-search text-blue-600 mr-2"></i>
                    Search & Filter
                </h3>
            </div>
            <div class="p-6">
                <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
                            Search
                        </label>
                        <input type="text"
                               name="search"
                               id="search"
                               value="{{ search_query }}"
                               placeholder="Tracking ID, Name, etc."
                               class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full">
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                            Status
                        </label>
                        <select name="status"
                                id="status"
                                class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full">
                            <option value="">All Statuses</option>
                            <option value="booked" {% if status_filter == 'booked' %}selected{% endif %}>Booked</option>
                            <option value="in_transit" {% if status_filter == 'in_transit' %}selected{% endif %}>In Transit</option>
                            <option value="out_for_delivery" {% if status_filter == 'out_for_delivery' %}selected{% endif %}>Out for Delivery</option>
                            <option value="delivered" {% if status_filter == 'delivered' %}selected{% endif %}>Delivered</option>
                            <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700 mb-2">
                            Destination Country
                        </label>
                        <select name="country"
                                id="country"
                                class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full">
                            <option value="">All Countries</option>
                            {% for country in countries %}
                                <option value="{{ country.id }}" {% if country_filter == country.id|string %}selected{% endif %}>
                                    {{ country.name }} ({{ country.currency }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="submit"
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 w-full">
                            <i class="fas fa-search mr-2"></i>
                            Search
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-boxes text-2xl text-blue-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">
                                    Total Shipments
                                </dt>
                                <dd class="text-lg font-medium text-gray-900">
                                    {{ total_shipments }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-dollar-sign text-2xl text-green-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">
                                    Total Revenue
                                </dt>
                                <dd class="text-lg font-medium text-gray-900">
                                    ${{ "%.2f"|format(total_revenue or 0) }}
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-weight text-2xl text-purple-600"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">
                                    Total Weight
                                </dt>
                                <dd class="text-lg font-medium text-gray-900">
                                    {{ "%.1f"|format(total_weight or 0) }} kg
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    Search Results
                </h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-500">
                    {% if shipments %}
                        Found {{ shipments|length }} shipment{{ 's' if shipments|length != 1 else '' }}
                    {% else %}
                        No shipments found matching your criteria
                    {% endif %}
                </p>
            </div>

            {% if shipments %}
                <ul class="divide-y divide-gray-200">
                    {% for shipment in shipments %}
                        <li>
                            <div class="px-4 py-4 sm:px-6">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center flex-1">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center">
                                                <i class="fas fa-shipping-fast text-gray-600"></i>
                                            </div>
                                        </div>
                                        <div class="ml-4 flex-1">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900 font-mono">
                                                        {{ shipment.tracking_id }}
                                                        {% if current_user.is_admin %}
                                                            <span class="ml-2 text-xs text-gray-500">(User: {{ shipment.branch.name }})</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="text-sm text-gray-500">
                                                        {{ shipment.sender_name }} → {{ shipment.receiver_name }} • {{ shipment.destination_country.name }}
                                                    </div>
                                                    <div class="text-xs text-gray-400 mt-1">
                                                        {{ shipment.final_price }} {{ shipment.destination_country.currency }} • {{ shipment.created_at.strftime('%b %d, %Y %I:%M %p') }}
                                                    </div>
                                                </div>
                                                <div class="flex items-center space-x-4">
                                                    <!-- Status Badge -->
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-badge
                                                        {% if shipment.status == 'booked' %}bg-yellow-100 text-yellow-800
                                                        {% elif shipment.status == 'in_transit' %}bg-blue-100 text-blue-800
                                                        {% elif shipment.status == 'out_for_delivery' %}bg-purple-100 text-purple-800
                                                        {% elif shipment.status == 'delivered' %}bg-green-100 text-green-800
                                                        {% else %}bg-red-100 text-red-800{% endif %}"
                                                        data-status="{{ shipment.status }}"
                                                        data-shipment-id="{{ shipment.id }}">
                                                        {{ shipment.status.title() }}
                                                    </span>

                                                    <!-- Status Update Dropdown -->
                                                    <div class="relative status-dropdown">
                                                        <select class="status-select block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"
                                                                data-shipment-id="{{ shipment.id }}">
                                                            <option value="booked" {% if shipment.status == 'booked' %}selected{% endif %}>Booked</option>
                                                            <option value="in_transit" {% if shipment.status == 'in_transit' %}selected{% endif %}>In Transit</option>
                                                            <option value="out_for_delivery" {% if shipment.status == 'out_for_delivery' %}selected{% endif %}>Out for Delivery</option>
                                                            <option value="delivered" {% if shipment.status == 'delivered' %}selected{% endif %}>Delivered</option>
                                                            <option value="cancelled" {% if shipment.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ml-4 flex items-center space-x-4">
                                        <div class="flex space-x-2">
                                            <a href="{{ url_for('shipment_slip', shipment_id=shipment.id) }}"
                                               class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                                                View Slip
                                            </a>
                                            <a href="{{ url_for('shipment_receipt', shipment_id=shipment.id) }}"
                                               class="text-green-600 hover:text-green-900 text-sm font-medium">
                                                Receipt
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    {% endfor %}
                </ul>

                <!-- Pagination -->
                {% if pagination.pages > 1 %}
                <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <div class="flex-1 flex justify-between sm:hidden">
                        {% if pagination.has_prev %}
                            <a href="{{ url_for('search_shipments', page=pagination.prev_num, search=search_query, status=status_filter, country=country_filter) }}"
                               class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Previous
                            </a>
                        {% endif %}
                        {% if pagination.has_next %}
                            <a href="{{ url_for('search_shipments', page=pagination.next_num, search=search_query, status=status_filter, country=country_filter) }}"
                               class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                Next
                            </a>
                        {% endif %}
                    </div>
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700">
                                Showing page <span class="font-medium">{{ pagination.page }}</span> of <span class="font-medium">{{ pagination.pages }}</span>
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                {% if pagination.has_prev %}
                                    <a href="{{ url_for('search_shipments', page=pagination.prev_num, search=search_query, status=status_filter, country=country_filter) }}"
                                       class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Previous</span>
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                {% endif %}

                                {% for page_num in pagination.iter_pages() %}
                                    {% if page_num %}
                                        {% if page_num == pagination.page %}
                                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-600 text-sm font-medium text-white">
                                                {{ page_num }}
                                            </span>
                                        {% else %}
                                            <a href="{{ url_for('search_shipments', page=page_num, search=search_query, status=status_filter, country=country_filter) }}"
                                               class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                                {{ page_num }}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                            ...
                                        </span>
                                    {% endif %}
                                {% endfor %}

                                {% if pagination.has_next %}
                                    <a href="{{ url_for('search_shipments', page=pagination.next_num, search=search_query, status=status_filter, country=country_filter) }}"
                                       class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Next</span>
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-search text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No shipments found</h3>
                    <p class="text-gray-500 mb-4">Try adjusting your search criteria or filters</p>
                    <a href="{{ url_for('search_shipments') }}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Clear Filters
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Status Update JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle status dropdown changes
    const statusSelects = document.querySelectorAll('.status-select');

    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const shipmentId = this.dataset.shipmentId;
            const newStatus = this.value;
            const statusBadge = document.querySelector(`.status-badge[data-shipment-id="${shipmentId}"]`);

            // Show loading state
            const originalText = this.textContent;
            this.disabled = true;

            // Send AJAX request to update status
            fetch(`/shipment/${shipmentId}/update-status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the status badge
                    statusBadge.textContent = newStatus.replace('_', ' ').toUpperCase();
                    statusBadge.dataset.status = newStatus;

                    // Update badge color
                    statusBadge.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full status-badge`;
                    switch(newStatus) {
                        case 'booked':
                            statusBadge.classList.add('bg-yellow-100', 'text-yellow-800');
                            break;
                        case 'in_transit':
                            statusBadge.classList.add('bg-blue-100', 'text-blue-800');
                            break;
                        case 'out_for_delivery':
                            statusBadge.classList.add('bg-purple-100', 'text-purple-800');
                            break;
                        case 'delivered':
                            statusBadge.classList.add('bg-green-100', 'text-green-800');
                            break;
                        case 'cancelled':
                            statusBadge.classList.add('bg-red-100', 'text-red-800');
                            break;
                    }

                    // Update dropdown selection
                    this.value = newStatus;

                    // Show success message
                    showNotification(data.message, 'success');
                } else {
                    // Show error message
                    showNotification(data.error, 'error');
                    // Reset dropdown to original value
                    this.value = statusBadge.dataset.status;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to update status. Please try again.', 'error');
                // Reset dropdown to original value
                this.value = statusBadge.dataset.status;
            })
            .finally(() => {
                // Re-enable dropdown
                this.disabled = false;
            });
        });
    });

    // Notification system
    function showNotification(message, type) {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.notification');
        existingNotifications.forEach(notification => notification.remove());

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification fixed top-4 right-4 px-6 py-4 rounded-md text-white z-50 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        }`;
        notification.textContent = message;

        // Add to page
        document.body.appendChild(notification);

        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
});
</script>

<style>
/* Status dropdown styling */
.status-select {
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    background-color: white;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
    min-width: 120px;
}

.status-select:focus {
    outline: none;
    ring: 2px;
    ring-color: #3b82f6;
    border-color: #3b82f6;
}

.status-select:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Status badge styling */
.status-badge {
    min-width: 80px;
    text-align: center;
}

/* Notification styling */
.notification {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %}