{% extends 'base.html' %}

{% block title %}Book Shipment - PICS{% endblock %}

{% block content %}
<div class="min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">
                {% if prefilled_sender %}
                    Book New Shipment
                    <span class="text-lg text-blue-600 font-normal">(Sender info pre-filled)</span>
                {% else %}
                    Book New Shipment
                {% endif %}
            </h1>
            <p class="mt-2 text-gray-600">
                {% if prefilled_sender %}
                    Fill in the receiver and package details to create your shipment
                {% else %}
                    Fill in the details to create your shipment
                {% endif %}
            </p>

            {% if prefilled_sender %}
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">
                            Sender Information Pre-filled
                        </h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>Your sender information has been automatically filled from your previous shipment. Please review and update the receiver and package details below.</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <form method="POST" class="space-y-6">
            {{ form.hidden_tag() }}

            <!-- Sender Information -->
            <div class="bg-white p-6 rounded-lg shadow {% if prefilled_sender %}border-2 border-green-200 bg-green-50{% endif %}">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-user text-blue-600 mr-2"></i>
                    Sender Information
                    {% if prefilled_sender %}
                        <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>
                            Pre-filled
                        </span>
                    {% endif %}
                </h2>

                <!-- Customer Search Section Removed -->

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {{ form.sender_name(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Full Name") }}
                    {{ form.sender_cnic(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="CNIC Number") }}
                    {{ form.sender_phone(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Phone Number") }}
                    {{ form.sender_postal_code(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Postal Code") }}
                    <div class="md:col-span-2">
                        {{ form.sender_address(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full", placeholder="Complete Address", rows="3") }}
                    </div>
                </div>

            </div>

            <!-- Receiver Information -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-user-friends text-green-600 mr-2"></i>
                    Receiver Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {{ form.receiver_name(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Full Name") }}
                    {{ form.receiver_cnic(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="CNIC Number") }}
                    {{ form.receiver_phone(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Phone Number") }}
                    {{ form.receiver_postal_code(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Postal Code") }}
                    <div class="md:col-span-2">
                        {{ form.receiver_address(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full", placeholder="Complete Address", rows="3") }}
                    </div>
                </div>
            </div>

            <!-- Package Information -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-box text-purple-600 mr-2"></i>
                    Package Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Destination Country</label>
                        {{ form.destination_country(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Package Type</label>
                        {{ form.document_type(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Weight Type</label>
                        {{ form.weight_type(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent") }}
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        {{ form.length(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Length (cm)") }}
                        {{ form.width(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Width (cm)") }}
                        {{ form.height(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Height (cm)") }}
                    </div>
                    <div>
                        {{ form.actual_weight(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent", placeholder="Actual Weight (kg)") }}
                    </div>
                </div>
            </div>

            <!-- Price Calculation -->
            <div id="priceCalculation" class="bg-blue-50 border border-blue-200 p-6 rounded-lg shadow hidden">
                <h2 class="text-xl font-semibold mb-4 flex items-center text-blue-900">
                    <i class="fas fa-calculator text-blue-600 mr-2"></i>
                    Price Calculation
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-3 rounded">
                        <div class="text-sm text-gray-600">Volumetric Weight</div>
                        <div id="volWeight" class="font-semibold text-blue-900">-</div>
                    </div>
                    <div class="bg-white p-3 rounded">
                        <div class="text-sm text-gray-600">Chargeable Weight</div>
                        <div id="chargeWeight" class="font-semibold text-blue-900">-</div>
                    </div>
                    <div class="bg-white p-3 rounded">
                        <div class="text-sm text-gray-600">Base Price</div>
                        <div id="basePrice" class="font-semibold text-blue-900">-</div>
                    </div>
                    <div class="bg-white p-3 rounded">
                        <div class="text-sm text-gray-600">GST (18%)</div>
                        <div id="gstAmount" class="font-semibold text-blue-900">-</div>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-blue-100 rounded">
                    <div class="text-sm text-gray-600">Final Price</div>
                    <div id="finalPrice" class="text-2xl font-bold text-blue-900">-</div>
                </div>
                <div class="mt-2 p-3 bg-green-100 rounded">
                    <div class="text-sm text-gray-600">Final Price (PKR)</div>
                    <div id="finalPricePKR" class="text-xl font-bold text-green-900">-</div>
                </div>
            </div>

            <!-- Undertaking Section -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-file-contract text-orange-600 mr-2"></i>
                    Terms and Conditions
                </h2>
                <div class="space-y-4">
                    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded">
                        <h3 class="font-semibold text-yellow-800 mb-2">Undertaking Declaration:</h3>
                        <div class="text-sm text-yellow-700 mb-3">
                            <p><strong>Sender Name:</strong> {{ form.sender_name.data or 'Please fill sender information above' }}</p>
                            <p><strong>Sender Phone:</strong> {{ form.sender_phone.data or 'Please fill sender information above' }}</p>
                        </div>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>• I, <strong>{{ form.sender_name.data or '[Sender Name]' }}</strong>, declare that the information provided is accurate and complete</li>
                            <li>• I understand that incorrect weight/dimensions may result in additional charges</li>
                            <li>• I accept responsibility for the contents of the package</li>
                            <li>• I agree to the company's terms of service and liability limitations</li>
                            <li>• I understand that prohibited items will be confiscated</li>
                        </ul>
                    </div>
                    <div class="flex items-start space-x-3">
                        <div class="flex items-center h-5">
                            {{ form.undertaking_accepted(class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded") }}
                        </div>
                        <div class="ml-3 text-sm">
                            <label for="undertaking_accepted" class="font-medium text-gray-700">
                                I have read and accept the Terms and Conditions (Optional)
                            </label>
                            <p class="text-gray-500">You can proceed with or without accepting the terms and conditions.</p>
                        </div>
                    </div>
                    <div>
                        <label for="undertaking_text" class="block text-sm font-medium text-gray-700 mb-2">
                            Special Instructions (Optional)
                        </label>
                        {{ form.undertaking_text(class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full", placeholder="Any special handling instructions or notes...", rows="3") }}
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center">
                <button type="submit" class="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    <i class="fas fa-paper-plane mr-2"></i>
                    Book Shipment & Generate Receipt
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Real-time price calculation
    const form = document.querySelector('form');
    const calculationDiv = document.getElementById('priceCalculation');

    // Add event listeners to all relevant inputs
    const inputs = form.querySelectorAll('input[name="destination_country"], input[name="length"], input[name="width"], input[name="height"], input[name="actual_weight"], select[name="weight_type"]');

    inputs.forEach(input => {
        input.addEventListener('change', calculatePrice);
        input.addEventListener('input', calculatePrice);
    });

    async function calculatePrice() {
        const formData = new FormData(form);

        // Check if all required fields are filled
        const country = formData.get('destination_country');
        const length = formData.get('length');
        const width = formData.get('width');
        const height = formData.get('height');
        const weight = formData.get('actual_weight');
        const weightType = formData.get('weight_type');

        if (country && length && width && height && weight && weightType) {
            try {
                const response = await fetch('/api/calculate-pricing', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        country_id: country,
                        length: parseFloat(length),
                        width: parseFloat(width),
                        height: parseFloat(height),
                        weight: parseFloat(weight),
                        weight_type: weightType
                    })
                });

                const result = await response.json();

                if (result.volumetric_weight) {
                    calculationDiv.classList.remove('hidden');

                    document.getElementById('volWeight').textContent = result.volumetric_weight + ' kg';
                    document.getElementById('chargeWeight').textContent = result.chargeable_weight + ' kg';
                    document.getElementById('basePrice').textContent = result.currency + ' ' + result.base_price;
                    document.getElementById('gstAmount').textContent = result.currency + ' ' + result.gst_amount;
                    document.getElementById('finalPrice').textContent = result.currency + ' ' + result.final_price;

                    // Calculate and display PKR price
                    const pkrPrice = convertToPKR(result.final_price, result.currency);
                    document.getElementById('finalPricePKR').textContent = 'PKR ' + pkrPrice.toFixed(2);
                } else {
                    calculationDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error calculating price:', error);
                calculationDiv.classList.add('hidden');
            }
        } else {
            calculationDiv.classList.add('hidden');
        }
    }


    // Currency conversion function for client-side calculations
    function convertToPKR(amount, fromCurrency) {
        const exchangeRates = {
            'USD': 278.50,
            'EUR': 295.00,
            'GBP': 345.00,
            'AED': 76.00,
            'SAR': 74.00
        };

        const rate = exchangeRates[fromCurrency] || 278.50; // Default to USD rate
        return amount * rate;
    }
</script>
{% endblock %}